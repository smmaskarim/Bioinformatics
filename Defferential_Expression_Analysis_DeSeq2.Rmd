---
title: "Proteomics"
output: html_document
date: "2025-08-08"
---


### Load Data
```{r}

# Load necessary packages
library(readr)
setwd("~/")
getwd()

## GSE164073
## https://doi.org/10.1016/j.stem.2021.04.028

library(readr)
count_matrix <- read_csv("GSE164073_Eye_count_matrix.csv")  # or include Downloads/ if needed
dim(count_matrix)
head(count_matrix, 3)

```

## Preprocessing

```{r}
# Suppose your tibble has a Gene column + counts
count_matrix <- as.data.frame(count_matrix)  # convert tibble to data.frame

# Set gene symbols as row names
rownames(count_matrix) <- count_matrix$Gene

# Remove the Gene column so only numeric counts remain
count_matrix <- count_matrix[, -which(names(count_matrix) == "Gene")]

# Ensure counts are integers
count_matrix[] <- lapply(count_matrix, function(x) as.integer(round(x)))

# check data
head(count_matrix, 3)

```

# create metadata

```{r}
sample_names <- colnames(count_matrix)

# Suppose the 19 samples are in order:
# 6 cornea (3 mock + 3 CoV2), 6 limbus (3 mock + 3 CoV2), 6 sclera (3 mock + 3 CoV2), + 1 extra?
# Adjust as needed to match your dataset
tissue <- c(rep("cornea",6), rep("limbus",6), rep("sclera",6))
condition <- c(rep(c("mock","CoV2"), each=3), rep(c("mock","CoV2"), each=3), rep(c("mock","CoV2"), each=3))

# Build colData
colData <- data.frame(tissue = tissue, condition = condition)
rownames(colData) <- sample_names

# Check
nrow(colData)   # should be 19
ncol(count_matrix)  # should be 19
colData
```

## If necessary, Convert Ensemble IDs to Gene Symbol

```{r}
if (!requireNamespace("org.Hs.eg.db", quietly = TRUE)) {
  BiocManager::install("org.Hs.eg.db")
}

library(org.Hs.eg.db)
library(AnnotationDbi)

# Example Ensembl IDs
ensembl_ids <- c("ENSG00000141510", "ENSG00000284733", "ENSG00000198727")

# Map Ensembl IDs to gene symbols
gene_symbols <- mapIds(org.Hs.eg.db,
                       keys = ensembl_ids,
                       column = "SYMBOL",
                       keytype = "ENSEMBL"
                      )

print(gene_symbols)

```

## Check if all column names in count_matrix are in colData or metadata rownames
```{r}
all(colnames(count_matrix) %in% rownames(colData))

# Check if all colData rownames are in count_matrix columns

all(rownames(colData) %in% colnames(count_matrix))


#Check the order of samples

#DESeq2 requires row order in colData to match column order in count_matrix:

all(rownames(colData) == colnames(count_matrix))

```

### differential expression analysis

#DESeq2 requires raw integer counts

```{r}

library(DESeq2)

dds <- DESeqDataSetFromMatrix(
  countData =  round(count_matrix),
  colData = colData,
  design = ~ condition   # adjust if you have other variables, e.g., ~ batch + condition
)

```

##  Filting before DeSeq2 creating
```{r}
dds <- dds[rowSums(counts(dds)) >= 10, ]  # keep genes with â‰¥10 counts across all samples

```
## Run DESeq2

```{r}
dds <- DESeq(dds)
res <- results(dds)

```

### check for NA
```{r}
res
```

```{r}

# Filter out genes with significant p-values (padj < 0.05)
significant_genes <- res[!is.na(res$padj) & res$padj < 0.05, ]

# Identify upregulated genes (log2FoldChange > 0)
upregulated_genes <- significant_genes[significant_genes$log2FoldChange > 0, ]

# Identify downregulated genes (log2FoldChange < 0)
downregulated_genes <- significant_genes[significant_genes$log2FoldChange < 0, ]

# Get the total number of upregulated and downregulated genes
num_upregulated <- nrow(upregulated_genes)
num_downregulated <- nrow(downregulated_genes)

# Print the results
cat("Number of upregulated genes:", num_upregulated, "\n")
cat("Number of downregulated genes:", num_downregulated, "\n")

```


## MA plot
```{r}

plotMA(res, ylim = c(-5,5))

```
# PCA plot
```{r}

vsd <- vst(dds, blind = FALSE)
plotPCA(vsd, intgroup = "tissue")

```
## Plotting VolcanoPlot
```{r}
# Clean DESeq2 results
res_df_clean <- res_df[!is.na(res_df$padj), ]

# Add regulation status and convert to factor
res_df_clean <- res_df_clean %>%
  mutate(
    Regulation = case_when(
      log2FoldChange > 0.58 & padj < 0.05  ~ "Up",
      log2FoldChange < -0.58 & padj < 0.05 ~ "Down",
      TRUE ~ "Not Significant"  # Keep "Not Significant" for the rest
    ),
    Regulation = factor(Regulation, levels = c("Down", "Not Significant", "Up"))  # Define the factor levels
  )

# Filter points above -log10(padj) > 50
res_df_clean <- res_df_clean %>%
  filter(-log10(padj) <= 50)

# Select top 5 Up and Down genes
top_up <- res_df_clean %>% filter(Regulation == "Up") %>% arrange(padj) %>% slice_head(n = 5)
top_down <- res_df_clean %>% filter(Regulation == "Down") %>% arrange(padj) %>% slice_head(n = 5)
top_genes <- bind_rows(top_up, top_down)

# Volcano plot with enhanced aesthetics
volcano = ggplot(res_df_clean, aes(x = log2FoldChange, y = -log10(padj), color = Regulation)) +
  geom_point(alpha = 0.65, size = 1.5) +  # Keep only one geom_point() layer
  scale_color_manual(
    values = c("Down" = "blue", "Not Significant" = "grey", "Up" = "red"),  # Color for all 3 categories
    breaks = c("Down", "Not Significant", "Up")  # Ensure all categories are in the legend
  ) +
  geom_vline(xintercept = c(-0.58, 0.58), linetype = "dashed", color = "black") +  # threshold lines
  geom_hline(yintercept = 1.2, linetype = "dashed", color = "black") +         # significance threshold
  geom_text_repel(data = top_genes, aes(label = rownames(top_genes)), size = 3, max.overlaps = 50, show.legend = FALSE) +  # Disable legend for text labels
  theme_minimal() +
  theme(
    axis.line.y.left = element_line(color = "black", size = 0.8),  # Solid left y-axis
    axis.line.x = element_line(color = "black", size = 0.8),       # Solid x-axis
    axis.line.y.right = element_blank(),                            # Remove right y-axis
    legend.position = c(0.8, 0.8),                                  # Custom position for the legend (X = 0.8, Y = 0.8)
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    legend.key.height = unit(1.5, "lines"), 
    legend.key.width = unit(2, "lines"),
    legend.spacing.y = unit(0.5, "cm"),  # Increase space between items in the legend
    legend.box.spacing = unit(0.5, "cm"),  # Adjust space around the legend box
    axis.ticks.length = unit(0.1, "cm"),                             # Increase the tick length
    axis.ticks = element_line(color = "black", size = 0.8),         # Black color and size for ticks
    axis.ticks.length.x = unit(0.15, "cm"),
    axis.ticks.length.y = unit(0.15, "cm"),
    panel.grid.major = element_blank(),   # Remove major grid lines
    panel.grid.minor = element_blank()    # Remove minor grid lines
  ) +
  labs(
    x = "log2 FC",
    y = "-log10 Adjusted p-value"
  )

# Display the plot
volcano


#save
ggsave("volcano.jpeg", plot = volcano, width = 8, height = 8)

```

# Heatmap
```{r}

# Load required libraries
library(pheatmap)
library(matrixStats)

# Select top 50 variable genes
top_var_genes <- head(order(rowVars(log_norm_counts), decreasing = TRUE), 50)
mat <- log_norm_counts[top_var_genes, ]

# Publication-ready color palette
pub_palette <- colorRampPalette(c("#5D3A9B", "white", "#D7191C"))(100) 
# "#5D3A9B" = violet, "#D7191C" = red

# Draw heatmap
heatmap = pheatmap(
  mat,
  scale = "row",
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  color = pub_palette,
  show_rownames = TRUE,
  show_colnames = TRUE,
  fontsize_row = 8,
  fontsize_col = 10,
  border_color = NA,
  main = #"Top 50 Variable Genes"
)


# Save plot
ggsave("heatmap.png", plot = heatmap, width = 10, height = 12)
heatmap

```
### Gene Ontology (GO) / Pathway Analysis

## #Identify enriched biological processes, molecular functions, or pathways.
```{r}

library(clusterProfiler)
library(org.Hs.eg.db)

enrich_result <- enrichGO(
                            gene = rownames(sig_genes),
                            OrgDb = org.Hs.eg.db,
                            keyType = "SYMBOL",
                            ont = "BP",  # BP, MF, CC
                            pAdjustMethod = "BH",
                            qvalueCutoff = 0.05)

# -----------------------------
# Step 4: Visualize results
# -----------------------------
# Dotplot (increase height for readability)
dp <- dotplot(enrich_result, showCategory = 20) +   # show top 30 GO terms
      ggtitle("GO Biological Process Enrichment") +
      theme_minimal()

# Save plot
ggsave("GO_dotplot.png", plot = dp, width = 10, height = 12)
dp
 

```
## Enriched Pathways
```{r}
# 1. Load required libraries
library(clusterProfiler)
library(org.Hs.eg.db)
library(DOSE)  # optional for enrichment visualization

# 2. Extract significant genes (for example, padj < 0.05 & |log2FC| > 1)
sig_genes <- subset(res, padj < 0.05 & abs(log2FoldChange) > 1)
gene_symbols <- rownames(sig_genes)

# 3. Map gene symbols to Entrez IDs
entrez_ids <- bitr(gene_symbols,
                   fromType = "SYMBOL",
                   toType = "ENTREZID",
                   OrgDb = org.Hs.eg.db)

# 4. GO enrichment analysis (Biological Process)
go_enrich <- enrichGO(gene         = entrez_ids$ENTREZID,
                      OrgDb        = org.Hs.eg.db,
                      ont          = "BP",       # BP, MF, CC
                      pAdjustMethod= "BH",
                      pvalueCutoff = 0.05,
                      qvalueCutoff = 0.05,
                      readable     = TRUE)

# 5. Visualize top enriched GO terms
dotplot(go_enrich, showCategory = 30) + ggtitle("Top 20 Enriched Biological Processes")

# Optional: KEGG pathway enrichment
kegg_enrich <- enrichKEGG(gene         = entrez_ids$ENTREZID,
                          organism     = "hsa",
                          pvalueCutoff = 0.05)

dotplot(kegg_enrich, showCategory = 30) + ggtitle("Top 20 Enriched KEGG Pathways")

```







